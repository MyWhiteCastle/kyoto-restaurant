---
title: "kyoto restaurant"
output: html_document
---
```{r}
pkgs = c("units","lucr")
for (pkg in pkgs){
  if (!(pkg %in% installed.packages()[, 1])){
    install.packages(pkg)
  }
}
library(dplyr)
library(tidyr)
library(stringr)
library(units)
library("lucr")
library(shiny)
library(shinythemes)
```

Load CSV File 
```{r}
Kyoto_Restaurant_raw = read.csv("Kyoto_Restaurant_Info.csv")
```

Clean Data
```{r}
#function
## clean function
clean_price = function(price){
  str_remove_all(price,"￥") %>% 
    str_replace("～","-") %>% 
    str_replace("^ -","0-") %>% 
    str_replace("30000-","30000+")
}

Kyoto_Restaurant =Kyoto_Restaurant_raw %>% 
  mutate(
    Station = as.factor(Station),
    FirstCategory = as.factor(FirstCategory),
    SecondCategory = as.factor(SecondCategory),
    DinnerPrice = clean_price(DinnerPrice) %>% as.factor(),
    LunchPrice  = clean_price(LunchPrice) %>% as.factor()
  )

class(Kyoto_Restaurant$SecondCategory)
```

```{r}
shinyApp(
  ui = fluidPage(
    theme = shinytheme('flatly'),
    titlePanel(h4("Kyoto Restaurant")),
    sidebarLayout(
      sidebarPanel(
        selectInput("station", label = h5("Select the station closest to your ideal restaurant"),
                    choices = levels(Kyoto_Restaurant$Station)),
        selectInput("first_category",label = h5("Select the food category"),
                    choices = levels(Kyoto_Restaurant$FirstCategory)),
        checkboxInput("choose_second_category","Optional: select the second food category",value = FALSE),
        conditionalPanel(
          "input.choose_second_category == true",
          selectInput("second_category",label = h5("Select the second food cetegory"),
                      choices = levels(Kyoto_Restaurant$SecondCategory))),
        radioButtons("Price_rough",label="Select the Price",
                     choices = list("￥","￥￥", "￥￥￥", "￥￥￥￥","￥￥￥￥￥")),
        conditionalPanel(
          "input.Price_rough == '￥'",
          checkboxGroupInput("price_range1", label = h5("Select the price range(JPY)"),
                             choices = levels(Kyoto_Restaurant$DinnerPrice)[1:2])),
        conditionalPanel(
          "input.Price_rough == '￥￥'",
          checkboxGroupInput("price_range2", label = h5("Select the price range(JPY)"), 
                             choices = levels(Kyoto_Restaurant$DinnerPrice)[c(5,7,9)])),
        conditionalPanel(
          "input.Price_rough == '￥￥￥'",
          checkboxGroupInput("price_range3", label = h5("Select the price range(JPY)"), 
                             choices = levels(Kyoto_Restaurant$DinnerPrice)[10:12])),
        conditionalPanel(
          "input.Price_rough == '￥￥￥￥'",
          checkboxGroupInput("price_range4", label = h5("Select the price range(JPY)"),
                             choices = levels(Kyoto_Restaurant$DinnerPrice)[3:4])),
        conditionalPanel(
          "input.Price_rough == '￥￥￥￥￥'",
          checkboxGroupInput("price_range5", label = h5("Select the price range(JPY)"), 
                             choices = levels(Kyoto_Restaurant$DinnerPrice)[c(6,8)])),
        actionButton("search", h5("Search"))
      ),
      mainPanel(
        tableOutput("restaurant")
      )
    )
  ),
  
  
  server = function(input, output, session){
    # Filter the restaurant, returning a data frame
    restaurants = reactive({
      #generate temp variables for input values
      station = input$station
      first_category = input$first_category
      dinner_price = case_when(
            input$Price_rough == "￥"~ input$price_range1,
            input$Price_rough == "￥￥" ~input$price_range2,
            input$Price_rough == "￥￥￥" ~input$price_range3,
            input$Price_rough == "￥￥￥￥" ~input$price_range4,
            input$Price_rough == "￥￥￥￥￥" ~input$price_range5)
      dinner_rating = input$dinner_rating
      
      # Apply filters
      r <- Kyoto_Restaurant %>%
        filter(
          Station == station,
          FirstCategory == first_category,
          DinnerPrice == dinner_price,
          DinnerRating == dinner_rating
        )
      
      # Optional filter
      if (input$choose_second_category ==TRUE){
        second_category = input$second_category
        r = r %>% 
          filter(SecondCategory == second_category)
      }
      
      r = as.data.frame(r)
   })
  
    output$restaurant = renderTable({
      output_restaurants = restaurants() %>% 
        select(Name,JapaneseName)
      })
  }
)
```



